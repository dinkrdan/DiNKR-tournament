<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DiNKR Americano RR</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', sans-serif; 
            background: #325682; 
            min-height: 100vh;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
            touch-action: manipulation;
            padding-bottom: 60px; /* Extra space for mobile scrolling */
        }
        .btn { 
            border: none; 
            border-radius: 8px; 
            font-weight: bold; 
            cursor: pointer; 
            transition: all 0.2s; 
            touch-action: manipulation;
        }
        .btn:hover { transform: translateY(-1px); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .input { 
            border: 2px solid #64748b; 
            border-radius: 4px; 
            padding: 12px; 
            font-size: 16px; 
            outline: none;
            touch-action: manipulation;
            -webkit-appearance: none;
            -moz-appearance: textfield;
        }
        .input:focus { border-color: #deff01; }
        .input::-webkit-outer-spin-button,
        .input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        .card { 
            background: rgba(255, 255, 255, 0.1); 
            backdrop-filter: blur(10px); 
            border-radius: 12px; 
            padding: 20px; 
            margin: 16px auto;
            width: 100%;
        }
        .error-message {
            background: #fed7d7;
            color: #9b2c2c;
            padding: 16px;
            border-radius: 8px;
            margin: 16px 0;
        }
        .success-message {
            background: #c6f6d5;
            color: #276749;
            padding: 16px;
            border-radius: 8px;
            margin: 16px 0;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #deff01;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Clickable player styles */
        .clickable-player {
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        .clickable-player:hover {
            background-color: #4a6fa5 !important;
            transform: scale(1.02);
        }
        .clickable-player.selected {
            background-color: #deff01 !important;
            color: #1a202c !important;
        }
        
        /* Player replacement dropdown */
        .player-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid #325682;
            border-radius: 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        
        .player-option {
            padding: 12px;
            cursor: pointer;
            border-bottom: 1px solid #e2e8f0;
            color: #1a202c;
            transition: background-color 0.2s;
        }
        
        .player-option:hover {
            background-color: #f8f9fa;
        }
        
        .player-option.unavailable {
            background-color: #fee;
            color: #999;
            cursor: not-allowed;
        }
        
        /* Number input with controls */
        .number-input-container {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .number-input-btn {
            background: #deff01;
            color: #1a202c;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 6px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .number-input-btn:hover {
            background: #c5d601;
            transform: translateY(-1px);
        }
        
        .number-input-btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
        }
        
        /* DiNKR Logo Styling */
        .dinkr-logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin-bottom: 16px;
        }
        .dinkr-tagline {
            font-size: 12px;
            color: #94a3b8;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 4px;
        }

        /* Ensure smooth scrolling on mobile */
        html { scroll-behavior: smooth; }
        
        /* Main container centering */
        .container {
            max-width: 400px; /* Optimized for mobile */
            margin: 0 auto;
            padding: 20px;
        }
        
        .wide-container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* Court styling improvements */
        .court-container {
            background: #f7fafc;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            display: grid;
            grid-template-columns: 2fr 1fr 4px 1fr 2fr;
            border: 4px solid white;
            border-radius: 4px;
        }
        
        .court-team {
            display: grid;
            grid-template-rows: 1fr 1fr;
        }
        
        .court-team.left {
            border-right: 4px solid white;
        }
        
        .court-team.right {
            border-left: 4px solid white;
        }
        
        .court-player {
            background-color: #325682;
            color: white;
            text-align: center;
            padding: 24px 16px;
            fontSize: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .court-player.top {
            border-bottom: 4px solid white;
        }
        
        .court-score-input {
            width: 52px;
            height: 52px;
            text-align: center;
            font-size: 22px;
            font-weight: bold;
            border: none;
            background-color: white;
            outline: none;
            border-radius: 4px;
            touch-action: manipulation;
        }
        
        .court-score-input:disabled {
            background-color: #f3f4f6;
            color: #9ca3af;
            cursor: not-allowed;
        }
        
        /* Prevent zoom on double-tap for inputs */
        input[type="tel"], input[type="text"], input[type="number"], select {
            font-size: 16px;
            transform: translateZ(0);
        }
    </style>
</head>
<body>
    <div id="root"></div>
    <script>
        const { useState, useCallback, useEffect, createElement: h } = React;
        
        // DiNKR Logo Component
        const DiNKRLogo = ({ size = 'normal' }) => {
            const logoSize = size === 'large' ? 80 : 60;
            const textSize = size === 'large' ? '36px' : '28px';
            
            return h('div', { 
                style: { textAlign: 'center', marginBottom: '24px' } 
            }, [
                h('div', { 
                    key: 'logo',
                    className: 'dinkr-logo' 
                }, [
                    h('div', { 
                        key: 'icon',
                        style: {
                            width: logoSize + 'px',
                            height: logoSize + 'px',
                            background: '#deff01',
                            borderRadius: '50%',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            fontSize: Math.round(logoSize * 0.5) + 'px'
                        }
                    }, '🏓'),
                    h('div', { key: 'text' }, [
                        h('div', { 
                            key: 'title',
                            style: {
                                fontSize: textSize,
                                fontWeight: 'bold',
                                color: '#deff01',
                                letterSpacing: '2px'
                            }
                        }, 'DiNKR'),
                        h('div', { 
                            key: 'tagline',
                            className: 'dinkr-tagline' 
                        }, 'MEET YOUR MATCH')
                    ])
                ])
            ]);
        };
        
        const Trophy = ({ size = 24 }) => {
            return h('div', {
                style: {
                    width: size + 'px',
                    height: size + 'px',
                    backgroundColor: '#deff01',
                    borderRadius: '50%',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    fontSize: Math.round(size * 0.6) + 'px'
                }
            }, '🏆');
        };
        
        const ChevronLeft = ({ size = 24 }) => {
            return h('div', {
                style: {
                    width: size + 'px',
                    height: size + 'px',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    fontSize: Math.round(size * 0.8) + 'px',
                    color: 'white'
                }
            }, '←');
        };

        const CheckCircle = ({ size = 24 }) => {
            return h('div', {
                style: {
                    width: size + 'px',
                    height: size + 'px',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    fontSize: Math.round(size * 0.8) + 'px',
                    color: 'white'
                }
            }, '✓');
        };

        // Number Input Component with +/- buttons
        const NumberInput = ({ value, onChange, min = 1, max = 100, label, helpText, style = {} }) => {
            const increment = () => {
                if (value < max) {
                    onChange(value + 1);
                }
            };

            const decrement = () => {
                if (value > min) {
                    onChange(value - 1);
                }
            };

            const handleInputChange = (e) => {
                const newValue = parseInt(e.target.value) || min;
                const clampedValue = Math.max(min, Math.min(max, newValue));
                onChange(clampedValue);
            };

            return h('div', { style: { marginBottom: '20px' } }, [
                h('label', { 
                    key: 'label',
                    style: { display: 'block', fontSize: '16px', fontWeight: '500', marginBottom: '8px', color: 'white' } 
                }, label),
                h('div', {
                    key: 'input-container',
                    className: 'number-input-container'
                }, [
                    h('button', {
                        key: 'decrement',
                        onClick: decrement,
                        disabled: value <= min,
                        className: 'number-input-btn',
                        type: 'button'
                    }, '−'),
                    h('input', { 
                        key: 'input',
                        type: 'number', 
                        min, 
                        max, 
                        value, 
                        onChange: handleInputChange,
                        className: 'input', 
                        style: { 
                            width: '100px',
                            textAlign: 'center',
                            backgroundColor: 'rgba(255, 255, 255, 0.15)', 
                            border: '2px solid rgba(255, 255, 255, 0.3)', 
                            color: 'white',
                            fontSize: '16px',
                            ...style
                        } 
                    }),
                    h('button', {
                        key: 'increment',
                        onClick: increment,
                        disabled: value >= max,
                        className: 'number-input-btn',
                        type: 'button'
                    }, '+')
                ]),
                helpText ? h('p', { 
                    key: 'help',
                    style: { fontSize: '14px', color: '#94a3b8', marginTop: '6px' } 
                }, helpText) : null
            ]);
        };

        // Score Validation Dialog Component
        const ScoreValidationDialog = ({ isOpen, onClose, teamAScore, teamBScore, onConfirm }) => {
            if (!isOpen) return null;

            return h('div', { 
                style: { 
                    position: 'fixed', 
                    top: 0, 
                    left: 0, 
                    right: 0, 
                    bottom: 0, 
                    backgroundColor: 'rgba(0, 0, 0, 0.9)', 
                    display: 'flex', 
                    alignItems: 'center', 
                    justifyContent: 'center', 
                    zIndex: 9999,
                    padding: '20px'
                } 
            }, [
                h('div', { 
                    style: { 
                        backgroundColor: 'white', 
                        borderRadius: '16px', 
                        padding: '32px', 
                        maxWidth: '400px', 
                        width: '100%',
                        color: '#1a202c',
                        textAlign: 'center'
                    } 
                }, [
                    h('h2', { 
                        key: 'title',
                        style: { fontSize: '24px', fontWeight: 'bold', marginBottom: '16px', color: '#dc2626' } 
                    }, '⚠️ Score Confirmation'),
                    
                    h('p', { 
                        key: 'message',
                        style: { marginBottom: '20px', fontSize: '16px', lineHeight: '1.5' } 
                    }, `It looks like neither team scored 11 points (${teamAScore} - ${teamBScore}). Please confirm this score or go back to edit it.`),
                    
                    h('div', { 
                        key: 'score-display',
                        style: {
                            backgroundColor: '#f8f9fa',
                            padding: '16px',
                            borderRadius: '8px',
                            marginBottom: '24px',
                            fontSize: '24px',
                            fontWeight: 'bold',
                            color: '#325682'
                        }
                    }, `${teamAScore} - ${teamBScore}`),
                    
                    h('div', { 
                        key: 'buttons',
                        style: { display: 'flex', gap: '16px', justifyContent: 'center' }
                    }, [
                        h('button', {
                            key: 'edit',
                            onClick: onClose,
                            style: {
                                backgroundColor: '#64748b',
                                color: 'white',
                                border: 'none',
                                padding: '16px 24px',
                                borderRadius: '8px',
                                fontSize: '16px',
                                fontWeight: 'bold',
                                cursor: 'pointer'
                            }
                        }, 'Edit Score'),
                        h('button', {
                            key: 'confirm',
                            onClick: onConfirm,
                            style: {
                                backgroundColor: '#deff01',
                                color: '#1a202c',
                                border: 'none',
                                padding: '16px 24px',
                                borderRadius: '8px',
                                fontSize: '16px',
                                fontWeight: 'bold',
                                cursor: 'pointer'
                            }
                        }, 'Confirm Score')
                    ])
                ])
            ]);
        };

        // Player Switch Dialog Component
        const PlayerSwitchDialog = ({ isOpen, onClose, tournament, currentRound, onSwitchesConfirmed }) => {
            const [switches, setSwitches] = useState([]);

            useEffect(() => {
                if (isOpen) {
                    setSwitches([]);
                }
            }, [isOpen]);

            if (!isOpen || !tournament) return null;

            const allPlayers = tournament.players;
            const currentMatches = tournament.schedule[currentRound]?.matches || [];

            const addSwitch = (oldPlayer, newPlayer) => {
                setSwitches(prev => {
                    // Remove any existing switch for the old player
                    const filtered = prev.filter(s => s.oldPlayer !== oldPlayer);
                    // Add the new switch
                    return [...filtered, { oldPlayer, newPlayer }];
                });
            };

            const removeSwitch = (oldPlayer) => {
                setSwitches(prev => prev.filter(s => s.oldPlayer !== oldPlayer));
            };

            const handleConfirm = () => {
                onSwitchesConfirmed(switches);
                onClose();
            };

            const getPlayingPlayers = () => {
                const playing = new Set();
                currentMatches.forEach(match => {
                    const [teamA, teamB] = match;
                    teamA.forEach(p => playing.add(p.name));
                    teamB.forEach(p => playing.add(p.name));
                });
                return playing;
            };

            const playingPlayers = getPlayingPlayers();

            return h('div', { 
                style: { 
                    position: 'fixed', 
                    top: 0, 
                    left: 0, 
                    right: 0, 
                    bottom: 0, 
                    backgroundColor: 'rgba(0, 0, 0, 0.9)', 
                    display: 'flex', 
                    alignItems: 'center', 
                    justifyContent: 'center', 
                    zIndex: 9999,
                    padding: '20px'
                } 
            }, [
                h('div', { 
                    style: { 
                        backgroundColor: 'white', 
                        borderRadius: '16px', 
                        padding: '32px', 
                        maxWidth: '600px', 
                        width: '100%',
                        maxHeight: '80vh',
                        overflowY: 'auto',
                        color: '#1a202c',
                        textAlign: 'center'
                    } 
                }, [
                    h('h2', { 
                        key: 'title',
                        style: { fontSize: '24px', fontWeight: 'bold', marginBottom: '16px', color: '#325682' } 
                    }, 'Manual Player Assignments'),
                    
                    h('p', { 
                        key: 'description',
                        style: { marginBottom: '24px', fontSize: '16px', color: '#64748b' } 
                    }, 'Click on any player name in the matches below to replace them with a different player.'),
                    
                    // Show current matches with clickable players
                    h('div', { 
                        key: 'matches',
                        style: { marginBottom: '24px' }
                    }, currentMatches.map((match, matchIndex) => {
                        const [teamA, teamB] = match;
                        return h('div', {
                            key: matchIndex,
                            style: {
                                border: '2px solid #325682',
                                borderRadius: '8px',
                                padding: '16px',
                                marginBottom: '16px',
                                backgroundColor: '#f8f9fa'
                            }
                        }, [
                            h('h4', { 
                                key: 'court-title',
                                style: { marginBottom: '12px', color: '#325682' } 
                            }, `Court ${matchIndex + 1}`),
                            h('div', {
                                key: 'teams',
                                style: { display: 'flex', justifyContent: 'space-around', alignItems: 'center' }
                            }, [
                                h('div', { key: 'teamA', style: { textAlign: 'center' } }, [
                                    h('div', { 
                                        key: 'team-label',
                                        style: { fontSize: '12px', color: '#64748b', marginBottom: '8px' } 
                                    }, 'Team A'),
                                    ...teamA.map((player, playerIndex) => 
                                        h('div', {
                                            key: `a-${playerIndex}`,
                                            style: {
                                                padding: '8px 12px',
                                                margin: '4px',
                                                backgroundColor: '#325682',
                                                color: 'white',
                                                borderRadius: '6px',
                                                cursor: 'pointer',
                                                fontSize: '14px'
                                            },
                                            onClick: () => {
                                                // Show available players for replacement
                                                const availablePlayerNames = allPlayers
                                                    .map(p => p.name || `${p.firstName} ${p.lastName}`.trim())
                                                    .filter(name => name !== player.name)
                                                    .sort();
                                                
                                                const playerList = availablePlayerNames.join(', ');
                                                const newPlayerName = prompt(
                                                    `Replace ${player.name} with:\n\nAvailable players: ${playerList}`, 
                                                    ''
                                                );
                                                
                                                if (newPlayerName) {
                                                    // Find player with flexible matching
                                                    const foundPlayer = allPlayers.find(p => {
                                                        const pName = p.name || `${p.firstName} ${p.lastName}`.trim();
                                                        return pName.toLowerCase() === newPlayerName.toLowerCase();
                                                    });
                                                    
                                                    if (foundPlayer) {
                                                        const foundPlayerName = foundPlayer.name || `${foundPlayer.firstName} ${foundPlayer.lastName}`.trim();
                                                        addSwitch(player.name, foundPlayerName);
                                                    } else {
                                                        alert(`Player "${newPlayerName}" not found. Please check spelling and try again.`);
                                                    }
                                                }
                                            }
                                        }, player.name)
                                    )
                                ]),
                                h('div', { 
                                    key: 'vs',
                                    style: { fontSize: '18px', fontWeight: 'bold', color: '#325682' } 
                                }, 'VS'),
                                h('div', { key: 'teamB', style: { textAlign: 'center' } }, [
                                    h('div', { 
                                        key: 'team-label',
                                        style: { fontSize: '12px', color: '#64748b', marginBottom: '8px' } 
                                    }, 'Team B'),
                                    ...teamB.map((player, playerIndex) => 
                                        h('div', {
                                            key: `b-${playerIndex}`,
                                            style: {
                                                padding: '8px 12px',
                                                margin: '4px',
                                                backgroundColor: '#325682',
                                                color: 'white',
                                                borderRadius: '6px',
                                                cursor: 'pointer',
                                                fontSize: '14px'
                                            },
                                            onClick: () => {
                                                // Show available players for replacement
                                                const availablePlayerNames = allPlayers
                                                    .map(p => p.name || `${p.firstName} ${p.lastName}`.trim())
                                                    .filter(name => name !== player.name)
                                                    .sort();
                                                
                                                const playerList = availablePlayerNames.join(', ');
                                                const newPlayerName = prompt(
                                                    `Replace ${player.name} with:\n\nAvailable players: ${playerList}`, 
                                                    ''
                                                );
                                                
                                                if (newPlayerName) {
                                                    // Find player with flexible matching
                                                    const foundPlayer = allPlayers.find(p => {
                                                        const pName = p.name || `${p.firstName} ${p.lastName}`.trim();
                                                        return pName.toLowerCase() === newPlayerName.toLowerCase();
                                                    });
                                                    
                                                    if (foundPlayer) {
                                                        const foundPlayerName = foundPlayer.name || `${foundPlayer.firstName} ${foundPlayer.lastName}`.trim();
                                                        addSwitch(player.name, foundPlayerName);
                                                    } else {
                                                        alert(`Player "${newPlayerName}" not found. Please check spelling and try again.`);
                                                    }
                                                }
                                            }
                                        }, player.name)
                                    )
                                ])
                            ])
                        ]);
                    })),
                    
                    // Show pending switches
                    switches.length > 0 ? h('div', {
                        key: 'pending-switches',
                        style: {
                            backgroundColor: '#f0f9ff',
                            border: '2px solid #325682',
                            borderRadius: '8px',
                            padding: '16px',
                            marginBottom: '24px'
                        }
                    }, [
                        h('h4', { 
                            key: 'switches-title',
                            style: { marginBottom: '12px', color: '#325682' } 
                        }, 'Pending Switches:'),
                        ...switches.map((switchItem, index) => 
                            h('div', {
                                key: index,
                                style: {
                                    display: 'flex',
                                    justifyContent: 'space-between',
                                    alignItems: 'center',
                                    padding: '8px',
                                    backgroundColor: 'white',
                                    borderRadius: '4px',
                                    marginBottom: '8px'
                                }
                            }, [
                                h('span', { key: 'switch-text' }, `${switchItem.oldPlayer} → ${switchItem.newPlayer}`),
                                h('button', {
                                    key: 'remove-switch',
                                    onClick: () => removeSwitch(switchItem.oldPlayer),
                                    style: {
                                        background: '#dc2626',
                                        color: 'white',
                                        border: 'none',
                                        borderRadius: '4px',
                                        padding: '4px 8px',
                                        cursor: 'pointer',
                                        fontSize: '12px'
                                    }
                                }, '✕')
                            ])
                        )
                    ]) : null,
                    
                    h('div', { 
                        key: 'buttons',
                        style: { display: 'flex', gap: '16px', justifyContent: 'center' }
                    }, [
                        h('button', {
                            key: 'no-changes',
                            onClick: () => { setSwitches([]); handleConfirm(); },
                            style: {
                                backgroundColor: '#64748b',
                                color: 'white',
                                border: 'none',
                                padding: '16px 24px',
                                borderRadius: '8px',
                                fontSize: '16px',
                                fontWeight: 'bold',
                                cursor: 'pointer'
                            }
                        }, 'Keep Auto Assignments'),
                        h('button', {
                            key: 'confirm',
                            onClick: handleConfirm,
                            style: {
                                backgroundColor: '#deff01',
                                color: '#1a202c',
                                border: 'none',
                                padding: '16px 24px',
                                borderRadius: '8px',
                                fontSize: '16px',
                                fontWeight: 'bold',
                                cursor: 'pointer'
                            }
                        }, switches.length > 0 ? `Apply ${switches.length} Switch${switches.length !== 1 ? 'es' : ''}` : 'Confirm Assignments')
                    ])
                ])
            ]);
        };

        const SkipPlayerDialog = ({ isOpen, onClose, tournament, currentRound, onSkipPlayersSelected, maxSkips }) => {
            const [selectedPlayers, setSelectedPlayers] = useState(new Set());

            useEffect(() => {
                if (isOpen) {
                    setSelectedPlayers(new Set());
                }
            }, [isOpen]);

            if (!isOpen || !tournament) return null;

            // Get all players who could potentially play (not currently sitting out)
            const allPlayers = tournament.players;
            
            // For the skip dialog, show all players since anyone can choose to skip
            const availablePlayers = allPlayers;

            const togglePlayer = (playerName) => {
                setSelectedPlayers(prev => {
                    const newSet = new Set(prev);
                    if (newSet.has(playerName)) {
                        newSet.delete(playerName);
                    } else if (newSet.size < maxSkips) {
                        newSet.add(playerName);
                    }
                    return newSet;
                });
            };

            const handleNoSkips = () => {
                setSelectedPlayers(new Set());
                onSkipPlayersSelected([]);
                onClose();
            };

            const handleConfirmSkips = () => {
                onSkipPlayersSelected(Array.from(selectedPlayers));
                onClose();
            };

            return h('div', { 
                style: { 
                    position: 'fixed', 
                    top: 0, 
                    left: 0, 
                    right: 0, 
                    bottom: 0, 
                    backgroundColor: 'rgba(0, 0, 0, 0.9)', 
                    display: 'flex', 
                    alignItems: 'center', 
                    justifyContent: 'center', 
                    zIndex: 9999,
                    padding: '20px'
                } 
            }, [
                h('div', { 
                    style: { 
                        backgroundColor: 'white', 
                        borderRadius: '16px', 
                        padding: '32px', 
                        maxWidth: '500px', 
                        width: '100%',
                        color: '#1a202c',
                        textAlign: 'center'
                    } 
                }, [
                    h('h2', { 
                        key: 'title',
                        style: { fontSize: '24px', fontWeight: 'bold', marginBottom: '16px', color: '#325682' } 
                    }, 'Next Round Setup'),
                    
                    h('p', { 
                        key: 'question',
                        style: { marginBottom: '24px', fontSize: '18px' } 
                    }, 'Do any players need to skip the next round?'),
                    
                    h('div', { 
                        key: 'instructions',
                        style: { marginBottom: '20px', fontSize: '14px', color: '#64748b' }
                    }, `Select up to ${maxSkips} player${maxSkips !== 1 ? 's' : ''} who need to skip:`),
                    
                    h('div', { 
                        key: 'players',
                        style: {
                            display: 'grid',
                            gridTemplateColumns: 'repeat(auto-fit, minmax(120px, 1fr))',
                            gap: '12px',
                            margin: '20px 0'
                        }
                    }, availablePlayers.map(player => {
                        const playerName = player.name || player.firstName;
                        const isSelected = selectedPlayers.has(playerName);
                        const canSelect = selectedPlayers.size < maxSkips || isSelected;
                        
                        return h('button', {
                            key: playerName,
                            onClick: () => togglePlayer(playerName),
                            disabled: !canSelect,
                            style: {
                                padding: '12px 8px',
                                border: `2px solid ${isSelected ? '#325682' : '#e2e8f0'}`,
                                borderRadius: '8px',
                                backgroundColor: isSelected ? '#deff01' : (canSelect ? 'white' : '#f8f9fa'),
                                cursor: canSelect ? 'pointer' : 'not-allowed',
                                fontSize: '14px',
                                fontWeight: '500',
                                color: isSelected ? '#1a202c' : (canSelect ? '#1a202c' : '#9ca3af'),
                                transition: 'all 0.2s'
                            }
                        }, playerName);
                    })),
                    
                    selectedPlayers.size > 0 ? h('p', {
                        key: 'selected-count',
                        style: { fontSize: '14px', color: '#325682', marginBottom: '20px' }
                    }, `${selectedPlayers.size} player${selectedPlayers.size !== 1 ? 's' : ''} selected to skip`) : null,
                    
                    h('div', { 
                        key: 'buttons',
                        style: { display: 'flex', gap: '16px', justifyContent: 'center' }
                    }, [
                        h('button', {
                            key: 'no-skips',
                            onClick: handleNoSkips,
                            style: {
                                backgroundColor: '#64748b',
                                color: 'white',
                                border: 'none',
                                padding: '16px 24px',
                                borderRadius: '8px',
                                fontSize: '16px',
                                fontWeight: 'bold',
                                cursor: 'pointer'
                            }
                        }, 'No Skips'),
                        h('button', {
                            key: 'confirm',
                            onClick: handleConfirmSkips,
                            disabled: selectedPlayers.size === 0,
                            style: {
                                backgroundColor: selectedPlayers.size > 0 ? '#deff01' : '#9ca3af',
                                color: '#1a202c',
                                border: 'none',
                                padding: '16px 24px',
                                borderRadius: '8px',
                                fontSize: '16px',
                                fontWeight: 'bold',
                                cursor: selectedPlayers.size > 0 ? 'pointer' : 'not-allowed'
                            }
                        }, 'Confirm Skips')
                    ])
                ])
            ]);
        };

        // Player Management Dialog
        const PlayerDialog = ({ isOpen, onClose, players, setPlayers, totalPlayers }) => {
            const [editingPlayers, setEditingPlayers] = useState([]);

            useEffect(() => {
                if (isOpen) {
                    // Initialize with current players or create new ones
                    const initialPlayers = [];
                    for (let i = 0; i < totalPlayers; i++) {
                        if (players[i]) {
                            initialPlayers.push(players[i]);
                        } else {
                            initialPlayers.push({
                                firstName: '',
                                lastName: '',
                                gender: 'M',
                                rating: 3.5
                            });
                        }
                    }
                    setEditingPlayers(initialPlayers);
                }
            }, [isOpen, players, totalPlayers]);

            const updatePlayer = (index, field, value) => {
                setEditingPlayers(prev => {
                    const updated = [...prev];
                    updated[index] = { ...updated[index], [field]: value };
                    return updated;
                });
            };

            const handleSave = () => {
                // Validate all players have first names
                const allValid = editingPlayers.every(p => p.firstName.trim());
                if (!allValid) {
                    alert('Please fill in all first names');
                    return;
                }
                
                setPlayers(editingPlayers);
                onClose();
            };

            const randomizeRatings = () => {
                setEditingPlayers(prev => prev.map(p => ({
                    ...p,
                    rating: Math.round((Math.random() * 1.5 + 3.0) * 10) / 10
                })));
            };

            if (!isOpen) return null;

            return h('div', { 
                style: { 
                    position: 'fixed', 
                    top: 0, 
                    left: 0, 
                    right: 0, 
                    bottom: 0, 
                    backgroundColor: 'rgba(0, 0, 0, 0.8)', 
                    display: 'flex', 
                    alignItems: 'center', 
                    justifyContent: 'center', 
                    zIndex: 9999,
                    padding: '20px'
                } 
            }, [
                h('div', { 
                    style: { 
                        backgroundColor: 'white', 
                        borderRadius: '12px', 
                        padding: '24px', 
                        maxWidth: '600px', 
                        width: '100%',
                        maxHeight: '80vh',
                        overflowY: 'auto',
                        color: '#1a202c'
                    } 
                }, [
                    h('div', { 
                        key: 'header',
                        style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' }
                    }, [
                        h('h2', { style: { fontSize: '24px', fontWeight: 'bold', color: '#325682' } }, 'Configure Players'),
                        h('button', {
                            onClick: randomizeRatings,
                            style: {
                                backgroundColor: '#deff01',
                                color: '#1a202c',
                                border: 'none',
                                padding: '8px 16px',
                                borderRadius: '6px',
                                fontSize: '14px',
                                fontWeight: 'bold',
                                cursor: 'pointer'
                            }
                        }, 'Randomize Ratings')
                    ]),
                    
                    h('div', { 
                        key: 'players',
                        style: { marginBottom: '24px' }
                    }, editingPlayers.map((player, index) => 
                        h('div', {
                            key: index,
                            style: {
                                display: 'grid',
                                gridTemplateColumns: '1fr 1fr 80px 80px',
                                gap: '12px',
                                marginBottom: '12px',
                                padding: '12px',
                                backgroundColor: '#f8f9fa',
                                borderRadius: '8px'
                            }
                        }, [
                            h('input', {
                                key: 'firstName',
                                type: 'text',
                                placeholder: 'First Name',
                                value: player.firstName,
                                onChange: (e) => updatePlayer(index, 'firstName', e.target.value),
                                style: {
                                    padding: '8px 12px',
                                    border: '2px solid #e2e8f0',
                                    borderRadius: '6px',
                                    fontSize: '14px'
                                }
                            }),
                            h('input', {
                                key: 'lastName',
                                type: 'text',
                                placeholder: 'Last Name',
                                value: player.lastName,
                                onChange: (e) => updatePlayer(index, 'lastName', e.target.value),
                                style: {
                                    padding: '8px 12px',
                                    border: '2px solid #e2e8f0',
                                    borderRadius: '6px',
                                    fontSize: '14px'
                                }
                            }),
                            h('select', {
                                key: 'gender',
                                value: player.gender,
                                onChange: (e) => updatePlayer(index, 'gender', e.target.value),
                                style: {
                                    padding: '8px 12px',
                                    border: '2px solid #e2e8f0',
                                    borderRadius: '6px',
                                    fontSize: '14px'
                                }
                            }, [
                                h('option', { value: 'M' }, 'Male'),
                                h('option', { value: 'F' }, 'Female')
                            ]),
                            h('input', {
                                key: 'rating',
                                type: 'number',
                                min: 2.0,
                                max: 5.0,
                                step: 0.1,
                                value: player.rating,
                                onChange: (e) => updatePlayer(index, 'rating', parseFloat(e.target.value) || 3.5),
                                style: {
                                    padding: '8px 12px',
                                    border: '2px solid #e2e8f0',
                                    borderRadius: '6px',
                                    fontSize: '14px'
                                }
                            })
                        ])
                    )),
                    
                    h('div', { 
                        key: 'buttons',
                        style: { display: 'flex', gap: '12px', justifyContent: 'flex-end' }
                    }, [
                        h('button', {
                            key: 'cancel',
                            onClick: onClose,
                            style: {
                                backgroundColor: '#64748b',
                                color: 'white',
                                border: 'none',
                                padding: '12px 24px',
                                borderRadius: '8px',
                                fontSize: '16px',
                                fontWeight: 'bold',
                                cursor: 'pointer'
                            }
                        }, 'Cancel'),
                        h('button', {
                            key: 'save',
                            onClick: handleSave,
                            style: {
                                backgroundColor: '#deff01',
                                color: '#1a202c',
                                border: 'none',
                                padding: '12px 24px',
                                borderRadius: '8px',
                                fontSize: '16px',
                                fontWeight: 'bold',
                                cursor: 'pointer'
                            }
                        }, 'Save Players')
                    ])
                ])
            ]);
        };

        // Enhanced Court Component with Improved Styling
        const Court = ({ match, matchIndex, roundIndex, courtNumber, scores, updateScore, onScoreValidation, allowPlayerEditing = false, onPlayerClick, roundStarted = true }) => {
            const [teamA, teamB] = match;
            const matchScores = scores[roundIndex]?.[matchIndex] || { teamA: '', teamB: '' };

            const handleScoreChange = (team, value) => {
                if (!roundStarted) return; // Don't allow score changes until round starts
                
                // Always update the display immediately
                updateScore(roundIndex, matchIndex, team, value);
                
                // Only validate if both scores are complete (not partial entries)
                const otherTeam = team === 'teamA' ? 'teamB' : 'teamA';
                const otherScore = team === 'teamA' ? matchScores.teamB : matchScores.teamA;
                
                // Get current scores
                const currentTeamAScore = team === 'teamA' ? value : otherScore;
                const currentTeamBScore = team === 'teamB' ? value : otherScore;
                
                // Only validate if both scores exist and are 2+ digits or complete entries
                if (currentTeamAScore && currentTeamBScore && 
                    currentTeamAScore.length >= 1 && currentTeamBScore.length >= 1) {
                    
                    const scoreA = parseInt(currentTeamAScore) || 0;
                    const scoreB = parseInt(currentTeamBScore) || 0;
                    
                    // Only validate if user seems done typing (both scores >= 10 or one is clearly final)
                    const bothScoresLookFinal = (scoreA >= 10 || scoreB >= 10) || 
                                              (scoreA > 0 && scoreB > 0 && 
                                               currentTeamAScore.length >= 2 && currentTeamBScore.length >= 2);
                    
                    if (bothScoresLookFinal && scoreA < 11 && scoreB < 11 && (scoreA > 0 || scoreB > 0)) {
                        // Add small delay to avoid validating while typing
                        setTimeout(() => {
                            const finalA = parseInt(scores[roundIndex]?.[matchIndex]?.teamA) || 0;
                            const finalB = parseInt(scores[roundIndex]?.[matchIndex]?.teamB) || 0;
                            if (finalA < 11 && finalB < 11 && (finalA > 0 || finalB > 0)) {
                                onScoreValidation(roundIndex, matchIndex, finalA, finalB);
                            }
                        }, 1000);
                    }
                }
            };

            const renderPlayer = (player, team, position) => {
                const playerStyle = {
                    backgroundColor: '#325682',
                    color: 'white',
                    textAlign: 'center',
                    padding: '24px 16px',
                    fontSize: '18px',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center'
                };

                if (position === 0) {
                    playerStyle.borderBottom = '4px solid white';
                }

                if (allowPlayerEditing) {
                    playerStyle.cursor = 'pointer';
                    playerStyle.transition = 'all 0.2s';
                }

                return h('div', {
                    key: `player-${team}-${position}`,
                    style: playerStyle,
                    onClick: allowPlayerEditing ? () => onPlayerClick(player) : undefined,
                    className: allowPlayerEditing ? 'clickable-player' : ''
                }, player.firstName || player.name);
            };

            return h('div', { style: { margin: '0 auto 24px', maxWidth: '100%', width: '100%' } }, [
                h('div', { key: 'top-post', style: { display: 'flex', justifyContent: 'center', marginBottom: '4px' } },
                    h('div', { style: { width: '8px', height: '16px', backgroundColor: '#000' } })
                ),
                h('div', { 
                    key: 'court', 
                    style: { 
                        backgroundColor: '#f7fafc', 
                        boxShadow: '0 10px 15px -3px rgba(0, 0, 0, 0.1)', 
                        display: 'grid', 
                        gridTemplateColumns: '2fr 1fr 4px 1fr 2fr', 
                        border: '4px solid white',
                        borderRadius: '4px',
                        width: '100%',
                        maxWidth: '380px',
                        margin: '0 auto'
                    } 
                }, [
                    h('div', { 
                        key: 'left-team', 
                        style: { 
                            display: 'grid', 
                            gridTemplateRows: '1fr 1fr', 
                            borderRight: '4px solid white' 
                        } 
                    }, [
                        renderPlayer(teamA[0], 'A', 0),
                        renderPlayer(teamA[1], 'A', 1)
                    ]),
                    h('div', { key: 'left-score', style: { backgroundColor: '#a0aec0', display: 'flex', alignItems: 'center', justifyContent: 'center' } },
                        h('input', {
                            type: 'tel',
                            inputMode: 'numeric',
                            value: matchScores.teamA,
                            disabled: !roundStarted,
                            onChange: (e) => {
                                const value = e.target.value.replace(/[^0-9]/g, '');
                                const numValue = parseInt(value) || 0;
                                if (value === '' || numValue <= 15) {
                                    handleScoreChange('teamA', value);
                                }
                            },
                            onFocus: (e) => { e.target.select(); },
                            style: { 
                                width: '52px', 
                                height: '52px', 
                                textAlign: 'center', 
                                fontSize: '22px', 
                                fontWeight: 'bold', 
                                border: 'none', 
                                backgroundColor: roundStarted ? 'white' : '#f3f4f6', 
                                color: roundStarted ? 'black' : '#9ca3af',
                                outline: 'none', 
                                borderRadius: '4px', 
                                touchAction: 'manipulation',
                                cursor: roundStarted ? 'text' : 'not-allowed'
                            },
                            placeholder: roundStarted ? '0' : '—'
                        })
                    ),
                    h('div', { key: 'net', style: { backgroundColor: '#000' } }),
                    h('div', { key: 'right-score', style: { backgroundColor: '#a0aec0', display: 'flex', alignItems: 'center', justifyContent: 'center' } },
                        h('input', {
                            type: 'tel',
                            inputMode: 'numeric',
                            value: matchScores.teamB,
                            disabled: !roundStarted,
                            onChange: (e) => {
                                const value = e.target.value.replace(/[^0-9]/g, '');
                                const numValue = parseInt(value) || 0;
                                if (value === '' || numValue <= 15) {
                                    handleScoreChange('teamB', value);
                                }
                            },
                            onFocus: (e) => { e.target.select(); },
                            style: { 
                                width: '52px', 
                                height: '52px', 
                                textAlign: 'center', 
                                fontSize: '22px', 
                                fontWeight: 'bold', 
                                border: 'none', 
                                backgroundColor: roundStarted ? 'white' : '#f3f4f6', 
                                color: roundStarted ? 'black' : '#9ca3af',
                                outline: 'none', 
                                borderRadius: '4px', 
                                touchAction: 'manipulation',
                                cursor: roundStarted ? 'text' : 'not-allowed'
                            },
                            placeholder: roundStarted ? '0' : '—'
                        })
                    ),
                    h('div', { 
                        key: 'right-team', 
                        style: { 
                            display: 'grid', 
                            gridTemplateRows: '1fr 1fr', 
                            borderLeft: '4px solid white' 
                        } 
                    }, [
                        renderPlayer(teamB[0], 'B', 0),
                        renderPlayer(teamB[1], 'B', 1)
                    ])
                ]),
                h('div', { key: 'bottom-post', style: { display: 'flex', justifyContent: 'center', marginTop: '4px' } },
                    h('div', { style: { width: '8px', height: '16px', backgroundColor: '#000' } })
                ),
                h('div', { key: 'court-number', style: { textAlign: 'center', marginTop: '12px' } },
                    h('span', { style: { backgroundColor: '#deff01', color: '#1a202c', fontWeight: 'bold', padding: '8px 16px', fontSize: '18px', borderRadius: '4px' } }, `Court ${courtNumber}`)
                )
            ]);
        };

        // Main Tournament App Component
        const TournamentApp = () => {
            const [step, setStep] = useState(1);
            const [config, setConfig] = useState({
                courts: 2, 
                totalPlayers: 8, 
                rounds: 6, 
                useDefaults: true,
                avoidMMvsFF: true, 
                useRatingBalance: true, 
                ratingFactor: 3, 
                roundDuration: 13
            });
            const [players, setPlayers] = useState([]);
            const [showPlayerDialog, setShowPlayerDialog] = useState(false);
            const [tournament, setTournament] = useState(null);
            const [currentRound, setCurrentRound] = useState(0);
            const [scores, setScores] = useState({});
            const [phase, setPhase] = useState('setup');
            const [roundStarted, setRoundStarted] = useState(false);
            const [timeRemaining, setTimeRemaining] = useState(0);
            const [timerRunning, setTimerRunning] = useState(false);
            const [loading, setLoading] = useState(false);
            const [errorMessage, setErrorMessage] = useState('');
            const [successMessage, setSuccessMessage] = useState('');
            const [showSkipDialog, setShowSkipDialog] = useState(false);
            const [showSwitchDialog, setShowSwitchDialog] = useState(false);
            const [pendingSkipPlayers, setPendingSkipPlayers] = useState([]);
            
            // Score validation state
            const [scoreValidation, setScoreValidation] = useState({
                isOpen: false,
                roundIndex: null,
                matchIndex: null,
                teamAScore: null,
                teamBScore: null
            });

            // Timer effect
            useEffect(() => {
                let interval;
                if (timerRunning && timeRemaining > 0) {
                    interval = setInterval(() => {
                        setTimeRemaining(prev => {
                            if (prev <= 1) {
                                setTimerRunning(false);
                                return 0;
                            }
                            return prev - 1;
                        });
                    }, 1000);
                }
                return () => clearInterval(interval);
            }, [timerRunning, timeRemaining]);

            const showError = (message) => {
                setErrorMessage(message);
                setTimeout(() => setErrorMessage(''), 5000);
            };

            const showSuccess = (message) => {
                setSuccessMessage(message);
                setTimeout(() => setSuccessMessage(''), 3000);
            };

            const generateTournament = async () => {
                setLoading(true);
                setErrorMessage('');
                
                try {
                    // Prepare players data
                    let playersToSend = [];
                    if (!config.useDefaults) {
                        // Convert custom players to format expected by backend
                        playersToSend = players.map(p => ({
                            name: `${p.firstName} ${p.lastName}`.trim(),
                            firstName: p.firstName,
                            lastName: p.lastName,
                            gender: p.gender,
                            rating: p.rating
                        }));
                    }

                    const requestData = {
                        courts: config.courts,
                        players: playersToSend,
                        rounds: config.rounds,
                        useDefaults: config.useDefaults,
                        avoidMMvsFF: config.avoidMMvsFF,
                        useRatingBalance: config.useRatingBalance,
                        ratingFactor: config.ratingFactor,
                        roundDuration: config.roundDuration,
                        totalPlayers: config.totalPlayers
                    };

                    const response = await fetch('/api/generate_tournament', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(requestData)
                    });

                    const result = await response.json();

                    console.log('DEBUG: Tournament generation result:', result);
                    console.log('DEBUG: Number of rounds in schedule:', result?.schedule?.length);
                    console.log('DEBUG: Configured rounds:', config.rounds);

                    if (response.ok && result.success) {
                        setTournament(result);
                        setCurrentRound(0);
                        setScores({});
                        setPhase('setup'); // Start in setup phase to allow assignment review
                        showSuccess('Tournament generated successfully! Review assignments or start Round 1.');
                        setStep(3);
                    } else {
                        showError(result.error || 'Failed to generate tournament');
                    }
                } catch (error) {
                    showError('Network error: ' + error.message);
                } finally {
                    setLoading(false);
                }
            };

            const updateScore = async (roundIndex, matchIndex, team, score) => {
                try {
                    const response = await fetch('/api/update_score', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            roundIndex,
                            matchIndex,
                            team,
                            score
                        })
                    });

                    if (response.ok) {
                        // Update local state
                        setScores(prev => ({
                            ...prev,
                            [roundIndex]: {
                                ...prev[roundIndex],
                                [matchIndex]: { 
                                    ...prev[roundIndex]?.[matchIndex], 
                                    [team]: score 
                                }
                            }
                        }));
                    } else {
                        showError('Failed to update score');
                    }
                } catch (error) {
                    showError('Network error: ' + error.message);
                }
            };

            const handleScoreValidation = (roundIndex, matchIndex, teamAScore, teamBScore) => {
                setScoreValidation({
                    isOpen: true,
                    roundIndex,
                    matchIndex,
                    teamAScore,
                    teamBScore
                });
            };

            const confirmScore = () => {
                // Score is already updated, just close the dialog
                setScoreValidation({
                    isOpen: false,
                    roundIndex: null,
                    matchIndex: null,
                    teamAScore: null,
                    teamBScore: null
                });
            };

            const closeScoreValidation = () => {
                setScoreValidation({
                    isOpen: false,
                    roundIndex: null,
                    matchIndex: null,
                    teamAScore: null,
                    teamBScore: null
                });
                // Optionally clear the scores to allow re-entry
                // This would require a separate API call to clear scores
            };

            const isRoundComplete = (roundIndex) => {
                if (!tournament || !scores[roundIndex]) return false;
                const roundMatches = tournament.schedule[roundIndex]?.matches || [];
                return roundMatches.every((match, matchIndex) => {
                    const matchScores = scores[roundIndex][matchIndex];
                    return matchScores && matchScores.teamA && matchScores.teamB;
                });
            };

            const handleAdvanceRound = () => {
                console.log(`DEBUG: handleAdvanceRound called`);
                console.log(`DEBUG: currentRound = ${currentRound}`);
                console.log(`DEBUG: tournament.schedule.length = ${tournament?.schedule?.length}`);
                console.log(`DEBUG: isLastRound calculation: ${currentRound} >= ${tournament?.schedule?.length - 1} = ${currentRound >= tournament?.schedule?.length - 1}`);
                
                if (currentRound < tournament.schedule.length - 1) {
                    // Calculate if skips are possible (more players than needed for courts)
                    const totalPlayers = tournament.players.length;
                    const playingPlayers = config.courts * 4;
                    const maxSkips = totalPlayers - playingPlayers;
                    
                    console.log(`DEBUG: Total players: ${totalPlayers}, Playing: ${playingPlayers}, Max skips: ${maxSkips}`);
                    
                    if (maxSkips > 0) {
                        setShowSkipDialog(true);
                    } else {
                        // No skips possible, go directly to switch dialog
                        setShowSwitchDialog(true);
                    }
                } else {
                    console.log(`DEBUG: Tournament completed - advancing to completed phase`);
                    setPhase('completed');
                }
            };

            const handleSkipPlayersSelected = (skipPlayers) => {
                setPendingSkipPlayers(skipPlayers);
                // After skip dialog, show switch dialog
                setShowSwitchDialog(true);
            };

            const handleSwitchesConfirmed = (switches) => {
                if (phase === 'setup') {
                    // For Round 1, apply switches and start playing immediately
                    applyRound1Switches(switches);
                } else {
                    // For subsequent rounds, advance with skip players and switches
                    const skipPlayers = pendingSkipPlayers;
                    setPendingSkipPlayers([]);
                    advanceRound(skipPlayers, switches);
                }
            };

            const applyRound1Switches = async (switches) => {
                try {
                    if (switches.length > 0) {
                        setLoading(true);
                        
                        console.log('DEBUG: Applying switches:', switches);
                        console.log('DEBUG: Tournament players:', tournament.players.map(p => p.name || `${p.firstName} ${p.lastName}`));
                        
                        const response = await fetch('/api/apply_player_switches', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                switches,
                                roundIndex: 0
                            })
                        });

                        const result = await response.json();
                        console.log('DEBUG: Switch response:', result);

                        if (response.ok && result.success) {
                            // Refresh tournament state
                            const stateResponse = await fetch('/api/get_tournament_state');
                            const state = await stateResponse.json();
                            
                            if (state.tournament) {
                                setTournament(state.tournament);
                            }
                            
                            showSuccess(`Applied ${switches.length} manual assignment(s) for Round 1`);
                        } else {
                            console.error('ERROR: Switch application failed:', result);
                            showError(result.error || 'Failed to apply switches - check console for details');
                        }
                    }
                    
                    // Transition to playing phase and start the round
                    setPhase('playing');
                    setRoundStarted(true);
                    setTimeRemaining(config.roundDuration * 60);
                    setTimerRunning(true);
                } catch (error) {
                    console.error('ERROR: Network error in applyRound1Switches:', error);
                    showError('Network error: ' + error.message);
                } finally {
                    setLoading(false);
                }
            };

            const advanceRound = async (skipPlayers = [], playerSwitches = []) => {
                try {
                    setLoading(true);
                    console.log(`DEBUG: advanceRound called with currentRound=${currentRound}, skipPlayers=${skipPlayers.length}, switches=${playerSwitches.length}`);
                    
                    const response = await fetch('/api/advance_round', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            skipPlayers,
                            playerSwitches
                        })
                    });

                    const result = await response.json();
                    console.log(`DEBUG: advanceRound response:`, result);

                    if (result.completed) {
                        console.log(`DEBUG: Server says tournament is completed`);
                        setPhase('completed');
                    } else if (result.success) {
                        // Refresh tournament state from server
                        const stateResponse = await fetch('/api/get_tournament_state');
                        const state = await stateResponse.json();
                        console.log(`DEBUG: Updated tournament state:`, state);
                        
                        if (state.tournament) {
                            setTournament(state.tournament);
                            setCurrentRound(state.current_round);
                            setScores(state.scores);
                            console.log(`DEBUG: Updated currentRound to ${state.current_round}`);
                            console.log(`DEBUG: Tournament has ${state.tournament.schedule.length} total rounds`);
                        }
                        
                        // Reset round state for new round
                        setRoundStarted(false);
                        setTimerRunning(false);
                        setTimeRemaining(0);
                        setPhase('playing'); // Go directly to playing phase for subsequent rounds
                        
                        let message = `Advanced to Round ${result.round + 1}`;
                        if (skipPlayers.length > 0) {
                            message += ` with ${skipPlayers.length} player(s) skipping`;
                        }
                        if (playerSwitches.length > 0) {
                            message += ` and ${playerSwitches.length} manual assignment(s)`;
                        }
                        showSuccess(message);
                    } else {
                        showError(result.error || 'Failed to advance round');
                    }
                } catch (error) {
                    console.error('ERROR: Network error in advanceRound:', error);
                    showError('Network error: ' + error.message);
                } finally {
                    setLoading(false);
                }
            };

            const startRound = () => {
                setRoundStarted(true);
                setTimeRemaining(config.roundDuration * 60);
                setTimerRunning(true);
            };

            const calculateTournamentResults = async () => {
                try {
                    const response = await fetch('/api/calculate_results');
                    const results = await response.json();
                    
                    if (results.error) {
                        showError('Failed to calculate results');
                        return null;
                    }
                    
                    // Enhanced analysis with performance metrics
                    const enhancedResults = results.map(player => {
                        const avgScore = player.matchesPlayed > 0 ? player.totalScore / player.matchesPlayed : 0;
                        const winRate = player.matchesPlayed > 0 ? (player.wins / player.matchesPlayed) * 100 : 0;
                        
                        // Simple performance calculation based on rating expectations
                        // Higher rated players are expected to score more
                        const expectedAvgScore = Math.max(6, Math.min(11, 5 + (player.rating - 3.0) * 2));
                        const performanceIndex = avgScore / expectedAvgScore;
                        
                        return {
                            ...player,
                            avgScore: Math.round(avgScore * 10) / 10,
                            winRate: Math.round(winRate),
                            expectedAvgScore: Math.round(expectedAvgScore * 10) / 10,
                            performanceIndex: Math.round(performanceIndex * 100) / 100,
                            performanceLabel: performanceIndex > 1.1 ? 'Exceeded' : 
                                            performanceIndex < 0.9 ? 'Below' : 'Met'
                        };
                    });
                    
                    return enhancedResults;
                } catch (error) {
                    showError('Network error calculating results');
                    return null;
                }
            };

            const formatTime = (seconds) => {
                const mins = Math.floor(seconds / 60);
                const secs = seconds % 60;
                return `${mins}:${secs.toString().padStart(2, '0')}`;
            };

            const isLastMinute = timeRemaining <= 60 && timeRemaining > 0;

            // Step 1: Configuration
            if (step === 1) {
                return h('div', { 
                    style: { 
                        minHeight: '100vh', 
                        background: '#325682', 
                        color: 'white',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        padding: '24px'
                    } 
                }, [
                    h('div', {
                        key: 'container',
                        style: {
                            width: '100%',
                            maxWidth: '600px'
                        }
                    }, [
                        h(DiNKRLogo, { key: 'logo' }),
                        
                        errorMessage ? h('div', { key: 'error', className: 'error-message' }, errorMessage) : null,
                        successMessage ? h('div', { key: 'success', className: 'success-message' }, successMessage) : null,
                        
                        h('div', { key: 'config', className: 'card' }, [
                            h('h3', { 
                                key: 'title', 
                                style: { fontSize: '20px', fontWeight: '600', marginBottom: '20px', color: '#deff01', textAlign: 'center' } 
                            }, 'Tournament Configuration'),
                            h('div', { 
                                key: 'fields', 
                                style: { display: 'flex', flexDirection: 'column', gap: '20px' } 
                            }, [
                                h(NumberInput, {
                                    key: 'courts',
                                    value: config.courts,
                                    onChange: (value) => setConfig(prev => ({...prev, courts: value})),
                                    min: 1,
                                    max: 10,
                                    label: 'Number of Courts'
                                }),
                                h(NumberInput, {
                                    key: 'players',
                                    value: config.totalPlayers,
                                    onChange: (value) => setConfig(prev => ({...prev, totalPlayers: value})),
                                    min: 4,
                                    max: 100,
                                    label: 'Number of Players',
                                    helpText: `Supports any number of players. ${config.courts * 4} will play each round.`
                                }),
                                h(NumberInput, {
                                    key: 'rounds',
                                    value: config.rounds,
                                    onChange: (value) => setConfig(prev => ({...prev, rounds: value})),
                                    min: 3,
                                    max: 15,
                                    label: 'Number of Rounds'
                                }),
                                h(NumberInput, {
                                    key: 'duration',
                                    value: config.roundDuration,
                                    onChange: (value) => setConfig(prev => ({...prev, roundDuration: value})),
                                    min: 10,
                                    max: 15,
                                    label: 'Round Duration (minutes)',
                                    helpText: 'Range: 10-15 minutes (default: 13)'
                                })
                            ])
                        ]),
                        
                        // Advanced Options
                        h('div', { key: 'advanced', className: 'card' }, [
                            h('h3', { 
                                key: 'advanced-title', 
                                style: { fontSize: '18px', fontWeight: '600', marginBottom: '16px', color: '#deff01', textAlign: 'center' } 
                            }, 'Advanced Options'),
                            h('div', { 
                                key: 'advanced-options',
                                style: { display: 'flex', flexDirection: 'column', gap: '16px' }
                            }, [
                                h('label', { 
                                    key: 'avoid-gender', 
                                    style: { display: 'flex', alignItems: 'center', gap: '12px', cursor: 'pointer' } 
                                }, [
                                    h('input', { 
                                        type: 'checkbox',
                                        checked: config.avoidMMvsFF, 
                                        onChange: (e) => setConfig(prev => ({...prev, avoidMMvsFF: e.target.checked})), 
                                        style: { width: '18px', height: '18px' } 
                                    }),
                                    h('span', { style: { fontSize: '14px' } }, 'Avoid Male vs Female matchups when possible')
                                ]),
                                h('label', { 
                                    key: 'rating-balance', 
                                    style: { display: 'flex', alignItems: 'center', gap: '12px', cursor: 'pointer' } 
                                }, [
                                    h('input', { 
                                        type: 'checkbox',
                                        checked: config.useRatingBalance, 
                                        onChange: (e) => setConfig(prev => ({...prev, useRatingBalance: e.target.checked})), 
                                        style: { width: '18px', height: '18px' } 
                                    }),
                                    h('span', { style: { fontSize: '14px' } }, 'Create balanced teams based on player ratings')
                                ])
                            ])
                        ]),
                        
                        loading ? h('div', { key: 'loading', className: 'spinner' }) : null,
                        
                        h('button', { 
                            key: 'next', 
                            onClick: () => setStep(2), 
                            disabled: loading, 
                            className: 'btn', 
                            style: { 
                                width: '100%', 
                                backgroundColor: loading ? '#64748b' : '#deff01', 
                                color: '#1e293b', 
                                padding: '18px', 
                                fontSize: '18px',
                                fontWeight: 'bold',
                                borderRadius: '12px'
                            } 
                        }, 'Next: Configure Players')
                    ])
                ]);
            }

            // Step 2: Player Configuration
            if (step === 2) {
                return h('div', { 
                    style: { 
                        minHeight: '100vh', 
                        background: '#325682', 
                        color: 'white', 
                        padding: '20px',
                        display: 'flex',
                        flexDirection: 'column',
                        alignItems: 'center'
                    } 
                }, [
                    h('div', {
                        key: 'container',
                        className: 'container'
                    }, [
                        h('div', { 
                            key: 'header', 
                            style: { display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: '24px' } 
                        }, [
                            h('button', { 
                                key: 'back', 
                                onClick: () => setStep(1), 
                                style: { 
                                    padding: '12px', 
                                    backgroundColor: 'rgba(255, 255, 255, 0.1)', 
                                    border: 'none', 
                                    color: 'white', 
                                    cursor: 'pointer', 
                                    borderRadius: '8px' 
                                } 
                            }, h(ChevronLeft, { size: 24 })),
                            h('h2', { 
                                key: 'title', 
                                style: { fontSize: '24px', fontWeight: 'bold', color: '#deff01' } 
                            }, 'Player Configuration'),
                            h('div', { style: { width: '48px' } })
                        ]),
                        
                        errorMessage ? h('div', { key: 'error', className: 'error-message' }, errorMessage) : null,
                        successMessage ? h('div', { key: 'success', className: 'success-message' }, successMessage) : null,
                        
                        h('div', { key: 'player-options', className: 'card' }, [
                            h('h3', { 
                                key: 'title', 
                                style: { marginBottom: '20px', color: '#deff01', fontSize: '20px', textAlign: 'center' } 
                            }, 'Player Setup'),
                            h('div', { 
                                key: 'options',
                                style: { display: 'flex', flexDirection: 'column', gap: '16px' }
                            }, [
                                h('label', { 
                                    key: 'defaults', 
                                    style: { display: 'flex', alignItems: 'center', gap: '12px', cursor: 'pointer' } 
                                }, [
                                    h('input', { 
                                        type: 'radio', 
                                        name: 'playerType',
                                        checked: config.useDefaults, 
                                        onChange: () => setConfig(prev => ({...prev, useDefaults: true})), 
                                        style: { width: '20px', height: '20px' } 
                                    }),
                                    h('span', { style: { fontSize: '16px' } }, 'Use default players with balanced ratings')
                                ]),
                                h('label', { 
                                    key: 'custom', 
                                    style: { display: 'flex', alignItems: 'center', gap: '12px', cursor: 'pointer' } 
                                }, [
                                    h('input', { 
                                        type: 'radio', 
                                        name: 'playerType',
                                        checked: !config.useDefaults, 
                                        onChange: () => setConfig(prev => ({...prev, useDefaults: false})), 
                                        style: { width: '20px', height: '20px' } 
                                    }),
                                    h('span', { style: { fontSize: '16px' } }, 'Add custom players')
                                ])
                            ]),
                            
                            !config.useDefaults ? h('div', { 
                                key: 'custom-controls',
                                style: { marginTop: '20px', textAlign: 'center' }
                            }, [
                                h('button', {
                                    onClick: () => setShowPlayerDialog(true),
                                    style: {
                                        backgroundColor: '#deff01',
                                        color: '#1a202c',
                                        border: 'none',
                                        padding: '12px 24px',
                                        borderRadius: '8px',
                                        fontSize: '16px',
                                        fontWeight: 'bold',
                                        cursor: 'pointer'
                                    }
                                }, `Configure ${config.totalPlayers} Players`)
                            ]) : h('div', { 
                                key: 'default-info',
                                style: { marginTop: '20px', fontSize: '14px', color: '#94a3b8', textAlign: 'center' }
                            }, `The system will automatically select ${config.totalPlayers} players with balanced ratings and mixed genders.`)
                        ]),
                        
                        loading ? h('div', { key: 'loading', className: 'spinner' }) : null,
                        
                        h('button', { 
                            key: 'generate', 
                            onClick: generateTournament, 
                            disabled: loading || (!config.useDefaults && players.length !== config.totalPlayers),
                            className: 'btn', 
                            style: { 
                                width: '100%', 
                                backgroundColor: (loading || (!config.useDefaults && players.length !== config.totalPlayers)) ? '#64748b' : '#deff01', 
                                color: '#1e293b', 
                                padding: '18px', 
                                fontSize: '18px',
                                fontWeight: 'bold',
                                borderRadius: '12px'
                            } 
                        }, loading ? 'Generating Tournament...' : 'Generate Tournament'),

                        // Player Dialog
                        h(PlayerDialog, {
                            key: 'player-dialog',
                            isOpen: showPlayerDialog,
                            onClose: () => setShowPlayerDialog(false),
                            players,
                            setPlayers,
                            totalPlayers: config.totalPlayers
                        })
                    ])
                ]);
            }

            // Step 3: Tournament Play
            if (step === 3 && tournament) {
                const currentRoundData = tournament.schedule[currentRound];
                const isCurrentRoundComplete = isRoundComplete(currentRound);
                const isLastRound = currentRound >= tournament.schedule.length - 1;

                if (phase === 'completed') {
                    // Tournament Results
                    const [results, setResults] = useState(null);
                    
                    useEffect(() => {
                        calculateTournamentResults().then(setResults);
                    }, []);
                    
                    if (!results) {
                        return h('div', { 
                            style: { 
                                minHeight: '100vh', 
                                background: '#325682', 
                                color: 'white', 
                                padding: '24px',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center'
                            } 
                        }, [h('div', { className: 'spinner' })]);
                    }
                    
                    // Separate by gender and calculate winners
                    const maleResults = results.filter(p => p.gender === 'M').sort((a, b) => b.totalScore - a.totalScore);
                    const femaleResults = results.filter(p => p.gender === 'F').sort((a, b) => b.totalScore - a.totalScore);
                    const overallResults = results.sort((a, b) => b.totalScore - a.totalScore);
                    const performanceResults = results.sort((a, b) => b.performanceIndex - a.performanceIndex);
                    
                    return h('div', { 
                        style: { 
                            minHeight: '100vh', 
                            background: '#325682', 
                            color: 'white', 
                            padding: '24px' 
                        } 
                    }, [
                        h('div', { 
                            key: 'header', 
                            style: { textAlign: 'center', marginBottom: '32px' } 
                        }, [
                            h(Trophy, { size: 80 }),
                            h('h1', { 
                                style: { fontSize: '36px', fontWeight: 'bold', color: '#deff01', marginTop: '20px' } 
                            }, 'Tournament Results!')
                        ]),
                        
                        // Overall Winner
                        h('div', { key: 'overall-winner', className: 'card' }, [
                            h('h2', { 
                                key: 'title',
                                style: { fontSize: '24px', fontWeight: 'bold', color: '#deff01', marginBottom: '16px', textAlign: 'center' } 
                            }, '🏆 Tournament Champion'),
                            h('div', { 
                                key: 'winner',
                                style: { 
                                    textAlign: 'center', 
                                    fontSize: '20px', 
                                    padding: '20px',
                                    backgroundColor: 'rgba(222, 255, 1, 0.2)',
                                    borderRadius: '8px',
                                    border: '2px solid #deff01'
                                } 
                            }, [
                                h('div', { 
                                    key: 'name',
                                    style: { fontSize: '24px', fontWeight: 'bold', marginBottom: '8px' } 
                                }, overallResults[0]?.name),
                                h('div', { 
                                    key: 'score',
                                    style: { fontSize: '18px', color: '#deff01' } 
                                }, `${overallResults[0]?.totalScore} points • ${overallResults[0]?.wins}/${overallResults[0]?.matchesPlayed} wins`)
                            ])
                        ]),
                        
                        // Gender Winners
                        h('div', { 
                            key: 'gender-winners',
                            style: { display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '16px', marginBottom: '24px' }
                        }, [
                            h('div', { key: 'male-winner', className: 'card' }, [
                                h('h3', { 
                                    key: 'title',
                                    style: { fontSize: '18px', fontWeight: 'bold', color: '#deff01', marginBottom: '12px', textAlign: 'center' } 
                                }, '👨 Male Winner'),
                                maleResults[0] ? h('div', { 
                                    key: 'winner',
                                    style: { textAlign: 'center' }
                                }, [
                                    h('div', { 
                                        key: 'name',
                                        style: { fontSize: '18px', fontWeight: 'bold', marginBottom: '4px' } 
                                    }, maleResults[0].name),
                                    h('div', { 
                                        key: 'score',
                                        style: { fontSize: '14px', color: '#deff01' } 
                                    }, `${maleResults[0].totalScore} pts`)
                                ]) : h('div', { style: { textAlign: 'center', fontSize: '14px', color: '#94a3b8' } }, 'No male participants')
                            ]),
                            h('div', { key: 'female-winner', className: 'card' }, [
                                h('h3', { 
                                    key: 'title',
                                    style: { fontSize: '18px', fontWeight: 'bold', color: '#deff01', marginBottom: '12px', textAlign: 'center' } 
                                }, '👩 Female Winner'),
                                femaleResults[0] ? h('div', { 
                                    key: 'winner',
                                    style: { textAlign: 'center' }
                                }, [
                                    h('div', { 
                                        key: 'name',
                                        style: { fontSize: '18px', fontWeight: 'bold', marginBottom: '4px' } 
                                    }, femaleResults[0].name),
                                    h('div', { 
                                        key: 'score',
                                        style: { fontSize: '14px', color: '#deff01' } 
                                    }, `${femaleResults[0].totalScore} pts`)
                                ]) : h('div', { style: { textAlign: 'center', fontSize: '14px', color: '#94a3b8' } }, 'No female participants')
                            ])
                        ]),
                        
                        // Performance Awards
                        h('div', { key: 'performance', className: 'card' }, [
                            h('h3', { 
                                key: 'title',
                                style: { fontSize: '18px', fontWeight: 'bold', color: '#deff01', marginBottom: '16px', textAlign: 'center' } 
                            }, '⭐ Best Performance (Exceeded Expectations)'),
                            h('div', { 
                                key: 'top-performers',
                                style: { display: 'grid', gap: '8px' }
                            }, performanceResults.slice(0, 3).map((player, index) => 
                                h('div', {
                                    key: index,
                                    style: {
                                        display: 'flex',
                                        justifyContent: 'space-between',
                                        alignItems: 'center',
                                        padding: '12px',
                                        backgroundColor: index === 0 ? 'rgba(222, 255, 1, 0.1)' : 'rgba(255, 255, 255, 0.05)',
                                        borderRadius: '6px',
                                        border: index === 0 ? '1px solid #deff01' : '1px solid rgba(255, 255, 255, 0.1)'
                                    }
                                }, [
                                    h('div', { key: 'info' }, [
                                        h('div', { 
                                            key: 'name',
                                            style: { fontWeight: 'bold', fontSize: '16px' } 
                                        }, `${index + 1}. ${player.name}`),
                                        h('div', { 
                                            key: 'details',
                                            style: { fontSize: '12px', color: '#94a3b8' } 
                                        }, `Avg: ${player.avgScore} (Expected: ${player.expectedAvgScore})`)
                                    ]),
                                    h('div', { 
                                        key: 'performance',
                                        style: { 
                                            fontSize: '14px', 
                                            fontWeight: 'bold',
                                            color: player.performanceIndex > 1.1 ? '#10b981' : player.performanceIndex < 0.9 ? '#ef4444' : '#94a3b8'
                                        } 
                                    }, `${Math.round((player.performanceIndex - 1) * 100)}%`)
                                ])
                            ))
                        ]),
                        
                        h('button', { 
                            key: 'restart', 
                            onClick: () => { 
                                setStep(1); 
                                setTournament(null);
                                setPhase('setup');
                                setCurrentRound(0);
                                setScores({});
                                setRoundStarted(false);
                                setTimerRunning(false);
                                setTimeRemaining(0);
                            }, 
                            className: 'btn', 
                            style: { 
                                width: '100%',
                                backgroundColor: '#deff01', 
                                color: '#1e293b', 
                                padding: '18px', 
                                fontSize: '18px',
                                fontWeight: 'bold',
                                borderRadius: '12px'
                            } 
                        }, 'Start New Tournament')
                    ]);
                }

                // Playing Phase with Beautiful Courts
                return h('div', { style: { minHeight: '100vh', background: '#325682' } }, [
                    h('div', { key: 'header', style: { backgroundColor: '#1a202c', color: 'white', padding: '8px 16px', position: 'sticky', top: 0, zIndex: 10 } },
                        h('div', { style: { display: 'flex', alignItems: 'center', justifyContent: 'space-between' } }, [
                            h('button', { key: 'back', onClick: () => setStep(2), style: { padding: '4px', backgroundColor: 'transparent', border: 'none', color: 'white', cursor: 'pointer', borderRadius: '4px' } }, h(ChevronLeft, { size: 20 })),
                            h('h2', { key: 'title', style: { fontSize: '18px', fontWeight: 'bold', color: '#deff01' } }, 
                                phase === 'setup' ? 'REVIEW ROUND 1 ASSIGNMENTS' : `ROUND ${currentRoundData?.round || 1}`
                            ),
                            h('div', { key: 'spacer', style: { width: '28px' } })
                        ])
                    ),
                    
                    h('div', { key: 'content-container', className: 'container' }, [
                        h('div', { key: 'content', style: { paddingBottom: '40px' } }, [
                        errorMessage ? h('div', { key: 'error', className: 'error-message' }, errorMessage) : null,
                        successMessage ? h('div', { key: 'success', className: 'success-message' }, successMessage) : null,
                        
                        // Round 1 Review Phase
                        phase === 'setup' ? h('div', { key: 'review-phase' }, [
                            h('div', { 
                                key: 'review-info',
                                style: { 
                                    backgroundColor: 'rgba(222, 255, 1, 0.2)', 
                                    border: '2px solid #deff01', 
                                    borderRadius: '8px', 
                                    padding: '16px', 
                                    marginBottom: '24px', 
                                    color: '#fef5e7',
                                    textAlign: 'center'
                                } 
                            }, [
                                h('h3', { 
                                    key: 'title',
                                    style: { fontSize: '18px', fontWeight: 'bold', marginBottom: '8px' } 
                                }, '🎯 Round 1 Assignments Generated'),
                                h('p', { 
                                    key: 'description',
                                    style: { fontSize: '14px', marginBottom: '12px' } 
                                }, 'Review the automatic assignments below. You can manually adjust any pairings before starting Round 1.'),
                                h('button', {
                                    key: 'review-btn',
                                    onClick: () => setShowSwitchDialog(true),
                                    style: {
                                        backgroundColor: '#deff01',
                                        color: '#1a202c',
                                        border: 'none',
                                        padding: '12px 24px',
                                        borderRadius: '8px',
                                        fontSize: '16px',
                                        fontWeight: 'bold',
                                        cursor: 'pointer',
                                        marginRight: '12px'
                                    }
                                }, '✏️ Adjust Assignments'),
                                h('button', {
                                    key: 'start-btn',
                                    onClick: () => {
                                        setPhase('playing');
                                        setRoundStarted(true);
                                        setTimeRemaining(config.roundDuration * 60);
                                        setTimerRunning(true);
                                    },
                                    style: {
                                        backgroundColor: '#16a34a',
                                        color: 'white',
                                        border: 'none',
                                        padding: '12px 24px',
                                        borderRadius: '8px',
                                        fontSize: '16px',
                                        fontWeight: 'bold',
                                        cursor: 'pointer'
                                    }
                                }, '▶️ Accept & Start Round 1')
                            ]),
                            
                            // Show Round 1 assignments (read-only)
                            ...currentRoundData.matches.map((match, matchIndex) => 
                                h(Court, { 
                                    key: `preview-${matchIndex}`, 
                                    match, 
                                    matchIndex, 
                                    roundIndex: currentRound, 
                                    courtNumber: matchIndex + 1,
                                    scores: {}, // No scores in preview
                                    updateScore: () => {}, // No scoring in preview
                                    onScoreValidation: () => {},
                                    allowPlayerEditing: false,
                                    roundStarted: false // Disabled in preview
                                })
                            ),
                            
                            // Show sit outs for Round 1
                            currentRoundData.sit_outs && currentRoundData.sit_outs.length > 0 ? h('div', { 
                                key: 'preview-sitouts', 
                                style: { 
                                    backgroundColor: 'rgba(107, 114, 128, 0.5)', 
                                    padding: '16px', 
                                    borderRadius: '8px', 
                                    marginBottom: '24px', 
                                    color: 'white' 
                                } 
                            }, [
                                h('strong', { style: { color: '#deff01' } }, 'Sitting Out Round 1: '), 
                                h('span', {}, currentRoundData.sit_outs.join(', '))
                            ]) : null
                        ]) : [
                            // Regular playing phase (Timer and active courts)
                            h('div', { key: 'timer-section', style: { textAlign: 'center', marginBottom: '20px' } }, [
                                !roundStarted ? h('button', {
                                    key: 'start-round',
                                    onClick: startRound,
                                    className: 'btn',
                                    style: {
                                        backgroundColor: '#16a34a',
                                        color: 'white',
                                        padding: '12px 24px',
                                        fontSize: '18px',
                                        fontWeight: 'bold',
                                        marginBottom: '10px'
                                    }
                                }, 'START ROUND') : null,
                                
                                roundStarted ? h('div', {
                                    key: 'timer-display',
                                    style: {
                                        display: 'inline-block',
                                        padding: '8px 16px',
                                        borderRadius: '8px',
                                        fontSize: '24px',
                                        fontWeight: 'bold',
                                        backgroundColor: isLastMinute ? '#dc2626' : 'white',
                                        color: isLastMinute ? 'white' : 'black',
                                        border: '2px solid #000'
                                    }
                                }, formatTime(timeRemaining)) : null
                            ]),
                            
                            // Beautiful Courts with scoring
                            ...currentRoundData.matches.map((match, matchIndex) => 
                                h(Court, { 
                                    key: matchIndex, 
                                    match, 
                                    matchIndex, 
                                    roundIndex: currentRound, 
                                    courtNumber: matchIndex + 1,
                                    scores,
                                    updateScore,
                                    onScoreValidation: handleScoreValidation,
                                    allowPlayerEditing: false,
                                    roundStarted: roundStarted
                                })
                            ),
                            
                            // Sit Outs
                            currentRoundData.sit_outs && currentRoundData.sit_outs.length > 0 ? h('div', { 
                                key: 'sitouts', 
                                style: { 
                                    backgroundColor: 'rgba(107, 114, 128, 0.5)', 
                                    padding: '16px', 
                                    borderRadius: '8px', 
                                    marginBottom: '24px', 
                                    color: 'white' 
                                } 
                            }, [
                                h('strong', { style: { color: '#deff01' } }, 'Sitting Out: '), 
                                h('span', {}, currentRoundData.sit_outs.join(', '))
                            ]) : null,
                            
                            // Round Controls
                            isCurrentRoundComplete ? h('button', { 
                                key: 'next', 
                                onClick: () => {
                                    console.log('DEBUG: Next Round button clicked');
                                    console.log('DEBUG: Current round:', currentRound);
                                    console.log('DEBUG: Total rounds in schedule:', tournament.schedule.length);
                                    console.log('DEBUG: Tournament schedule:', tournament.schedule.map(r => r.round));
                                    console.log('DEBUG: Is last round calculation:', currentRound >= tournament.schedule.length - 1);
                                    
                                    if (isLastRound) {
                                        console.log('DEBUG: Completing tournament');
                                        setPhase('completed');
                                    } else {
                                        console.log('DEBUG: Advancing to next round');
                                        handleAdvanceRound();
                                    }
                                }, 
                                disabled: loading,
                                className: 'btn', 
                                style: { 
                                    width: '100%', 
                                    backgroundColor: loading ? '#64748b' : (isLastRound ? '#805ad5' : '#deff01'), 
                                    color: isLastRound ? 'white' : '#1a202c', 
                                    padding: '16px', 
                                    fontSize: '18px', 
                                    display: 'flex', 
                                    alignItems: 'center', 
                                    justifyContent: 'center', 
                                    gap: '8px',
                                    fontWeight: 'bold'
                                } 
                            }, [
                                h(CheckCircle, { size: 24 }), 
                                h('span', {}, loading ? 'Loading...' : (isLastRound ? 'Show Results' : `Next Round (${currentRound + 2}/${tournament.schedule.length})`))
                            ]) : h('div', { 
                                key: 'waiting', 
                                style: { 
                                    width: '100%', 
                                    backgroundColor: '#718096', 
                                    color: '#cbd5e0', 
                                    fontWeight: 'bold', 
                                    padding: '16px', 
                                    borderRadius: '8px', 
                                    fontSize: '18px', 
                                    textAlign: 'center' 
                                } 
                            }, 'Enter all scores to continue')
                        ]
                    ]),

                    // Score Validation Dialog
                    h(ScoreValidationDialog, {
                        key: 'score-validation',
                        isOpen: scoreValidation.isOpen,
                        onClose: closeScoreValidation,
                        teamAScore: scoreValidation.teamAScore,
                        teamBScore: scoreValidation.teamBScore,
                        onConfirm: confirmScore
                    }),

                    // Skip Player Dialog
                    h(SkipPlayerDialog, {
                        key: 'skip-dialog',
                        isOpen: showSkipDialog,
                        onClose: () => setShowSkipDialog(false),
                        tournament,
                        currentRound,
                        onSkipPlayersSelected: handleSkipPlayersSelected,
                        maxSkips: tournament ? Math.max(0, tournament.players.length - (config.courts * 4)) : 0
                    }),

                    // Player Switch Dialog
                    h(PlayerSwitchDialog, {
                        key: 'switch-dialog',
                        isOpen: showSwitchDialog,
                        onClose: () => setShowSwitchDialog(false),
                        tournament,
                        currentRound: currentRound, // Use current round for Round 1 setup
                        onSwitchesConfirmed: handleSwitchesConfirmed
                    })
                ]);
            }

            // Loading state
            return h('div', { 
                style: { 
                    padding: '40px', 
                    textAlign: 'center', 
                    minHeight: '100vh', 
                    background: '#325682', 
                    color: 'white',
                    display: 'flex',
                    flexDirection: 'column',
                    alignItems: 'center',
                    justifyContent: 'center'
                } 
            }, [
                h(DiNKRLogo, { key: 'logo', size: 'large' }),
                h('h2', { style: { marginBottom: '20px' } }, 'Loading Tournament System...'),
                h('div', { className: 'spinner' })
            ]);
        };

        ReactDOM.render(React.createElement(TournamentApp), document.getElementById('root'));
    </script>
</body>
</html>
